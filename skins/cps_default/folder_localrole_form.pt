<html metal:use-macro="here/main_template/macros/master">
<body>

<div class="Desktop"
     metal:fill-slot="main"
     tal:define="searching python: request.get('role_submit', None );
                 mtool here/portal_membership;
                "
>

<div tal:condition="python: not searching">
<!-- Search -->

<h2>Assign local roles: Search Members</h2>

<form method="post" action="folder_localrole_form"
      tal:attributes="action string:${here/absolute_url}/folder_localrole_form"
>

<table class="FormLayout">
 <tr>
  <th>Search by</th>
  <td>
    <select name="search_param">
      <option value="username">User Name</option>
      <option value="groupname">Group Name</option>
      <option value="email">Email Address</option>
    </select>
  </td>
 </tr>
 <tr>
   <th>Search Term</th>
   <td><input type="text" name="search_term" size="30"></td>
 </tr>
 <tr>
  <td><br /></td>
   <td><input type="submit" name="role_submit" value=" Search "></td>
 </tr>
</table>

</form>


<!-- End search -->
</div>


<div tal:condition="python:searching and (search_param == 'username')"
  tal:define="search_param python: request.get( 'search_param', '' );
  search_term  python: request.get( 'search_term', '' );
  found python: mtool.searchMembers( search_param=search_param
                                          , search_term=search_term
                                          );
 "
>
<!-- Assignment -->
<h2>Assign local roles: Search Results</h2>

<div tal:condition="found">

 <p>Select Member(s) and a role to assign:</p>

 <form method="post" action="folder_localrole_edit"
       tal:attributes="action string:${here/absolute_url}/folder_localrole_edit"
 >
  <input type="hidden" name="change_type" value="add">

  <table class="FormLayout">

   <tr>
    <td width="16"><br></td>
    <th style="text-align:left;">User</th>
    <th style="text-align:left;">Email address</th>
   </tr>

   <tr tal:repeat="member found">
    <td width="16">
     <input type="checkbox" name="member_ids:list" 
            value=""
            tal:attributes="value member/username">
    </td>
    <td tal:content="member/username"> Username 1 </td>
    <td tal:content="member/email"> Email 1 </td>
   </tr>

   <tr tal:condition="nothing">
    <td width="16">
     <input type="checkbox" name="member_ids:list" value="">
    </td>
    <td> Username 2 </td>
    <td> Email 2 </td>
   </tr>

   <tr>
    <td colspan="3"><br></td>
   </tr>

   <tr>
    <th colspan="2">Role to assign:</th>
    <td>
     <select name="member_role"
             tal:define="roles python: mtool.getCandidateLocalRoles( here )">
      <option tal:repeat="role roles"
              tal:content="role"> Role1 </option>
      <option tal:condition="nothing"> Role2 </option>
      <option tal:condition="nothing"> Role3 </option>
     </select>
    </td>
   </tr>

   <tr>
    <td colspan="3"><br></td>
   </tr>

   <tr>
    <td width="16"><br></td>
    <td colspan="2"><input type="submit" value=" Assign Roles "></td>
   </tr>

  </table>
 </form>

</div>


<div tal:condition="python: not found">

 <p> Sorry, no members matched your search. </p>

</div>

<!-- End assignment -->

</div>

<div tal:condition="python:searching and (search_param == 'groupname')"
  tal:define="search_param python: request.get( 'search_param', '' );
  search_term  python: request.get( 'search_term', '' );
  found python: ['group:' +group for group in here.get_valid_groupids() if group.upper().find(search_term.upper()) > 0];
 "
>
<!-- Assignment -->
<h2>Assign local roles: Search Results</h2>

<div tal:condition="found">

 <p>Select Group(s) and a role to assign:</p>

 <form method="post" action="folder_localrole_edit"
       tal:attributes="action string:${here/absolute_url}/folder_localrole_edit"
 >
  <input type="hidden" name="change_type" value="add">
  
  <table class="FormLayout">

   <tr>
    <td width="16"><br></td>
    <th style="text-align:left;">Group Name</th>
    <th style="text-align:left;"></th>
   </tr>

   <tr tal:repeat="group found">
    <td width="16">
     <input type="checkbox" name="member_ids:list" 
            value=""
            tal:attributes="value group">
    </td>
    <td tal:content="python:group"> Groupame </td>
    <td>  </td>
   </tr>

   <tr>
    <td colspan="3"><br></td>
   </tr>

   <tr>
    <th colspan="2">Role to assign:</th>
    <td>
     <select name="member_role"
             tal:define="roles python: mtool.getCandidateLocalRoles( here )">
      <option tal:repeat="role roles"
              tal:content="role"> Role1 </option>
      <option tal:condition="nothing"> Role2 </option>
      <option tal:condition="nothing"> Role3 </option>
     </select>
    </td>
   </tr>

   <tr>
    <td colspan="3"><br></td>
   </tr>

   <tr>
    <td width="16"><br></td>
    <td colspan="2"><input type="submit" value=" Assign Roles "></td>
   </tr>

  </table>
 </form>

</div>


<div tal:condition="python: not found">

 <p> Sorry, no groups matched your search. </p>

</div>

<!-- End assignment -->

</div>

<hr>

<h2>Currently assigned local roles</h2>

<p>These users currently have local roles assigned in this folder:</p>

<form method="post" action="folder_localrole_edit"
      tal:attributes="action string:${here/absolute_url}/folder_localrole_edit"
>
 <input type="hidden" name="change_type" value="delete">
 <input type="hidden" name="member_role" value="">

 <table width="100%" class="FormLayout" 
   tal:define="lroles python:[('user:' + uroles[0],uroles[1]) for uroles in here.get_local_roles()] +
                              [('group:' + groles[0],groles[1]) for groles in here.get_local_group_roles()]"
 >
 <tr>
   <td width="16"><br></td>
   <th style="text-align:left;">User/Group</th>
   <th style="text-align:left;">Role(s)</th>
 </tr>
  
 <tal:block define="aq_roles python:here.portal_membership.getMergedLocalRoles(here);">
   <tal:block repeat="aq_user python:aq_roles.keys()">
     <tr tal:condition="python:aq_user not in [lrole[0] for lrole in lroles]" 
         tal:define="liste python:aq_roles[aq_user]; 
                     d python:{};
                     unique_aq_roles python:[item for item in liste if not(d.has_key(item)) and d.setdefault(item,1)]" >
       <td>&nbsp;</td>
       <td><span tal:content="aq_user"/></td>
       <td><i><span tal:content="python:modules['string'].join( unique_aq_roles, ', ' )"/></i></td>
     </tr>
   </tal:block>
 
   <tbody tal:repeat="role_tuple lroles">
     <tr tal:define="user_name python: role_tuple[0];
                 roles python: role_tuple[1];
                 auth mtool/getAuthenticatedMember;
                 auth_name auth/getUserName;
                "
     >
       <td width="16">
         <input type="checkbox" name="member_ids:list"
           value="id"
           tal:attributes="value user_name"
           tal:condition="python: user_name != auth_name"
       >
         <br tal:condition="python: user_name == auth_name">
       </td>
       <td tal:content="python:user_name"> Username 1 </td>
       <td tal:define="this_aq_roles python:[aq_role for aq_role in aq_roles[user_name] if aq_role not in roles]">
         <tal:block content="python: modules['string'].join( roles, ', ' )"/><tal:block condition="python:len(this_aq_roles)" content="string:, "/>
         <i tal:content="python:modules['string'].join(this_aq_roles, ', ')"></i>
       </td>
     </tr>
   </tbody>
 </tal:block>

 <tr tal:condition="nothing">
  <td width="16">
   <input type="checkbox" name="member_ids:list" value="id">
  </td>
  <td> Username 2 </td>
  <td> Role3 </td>
 </tr>

 <tr tal:condition="nothing">
  <td width="16">
   <br>
  </td>
  <td> Auth username </td>
  <td> Role1, Role2, Role3 </td>
 </tr>

 <tr>
  <td colspan="3"><br></td>
 </tr>

 <tr>
   <td><br></td>
   <td colspan="2"><input type="submit" value=" Delete "></td>
 </tr>

</table>
</form>
<br/>
<i>Roles in italic</i> are set in parent folders
</div>

</body>
</html>
