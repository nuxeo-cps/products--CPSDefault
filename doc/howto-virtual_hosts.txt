
HOWTO to setup CPS with Apache httpd VirtualHost directives
===========================================================

Sample HTTP + HTTPS configuration
---------------------------------

Here is a sample configuration using Apache httpd VirtualHost directives as it
can be setup on a Debian Woody machine. The port 9673 is the Zope default port
on Debian, you might have to change it to 8080 depending on your configuration.

<VirtualHost 192.168.2.20:80>
ServerName mysite.net

RewriteEngine on

RewriteCond %{HTTP:Authorization}  ^(.*)
RewriteRule ^/(.*) http://demo1.localdomain:9673/VirtualHostBase/http/%{HTTP_HOST}:80/cps/VirtualHostRoot/$1 [P,L]

CustomLog /var/log/apache-ssl/mysite.net.log combined
ErrorLog /var/log/apache-ssl/mysite.net-error.log
</VirtualHost>

<VirtualHost 192.168.2.20:443>
ServerName mysite.net
SSLEnable

RewriteEngine on

RewriteCond %{HTTP:Authorization}  ^(.*)
RewriteRule ^/(.*)  http://demo1.localdomain:9673/VirtualHostBase/https/%{HTTP_HOST}:443/cps/VirtualHostRoot/$1 [P,L]

CustomLog /var/log/apache-ssl/mysite.net.log combined
ErrorLog /var/log/apache-ssl/mysite.net-error.log
</VirtualHost>


Secure HTTP + HTTPS configuration
---------------------------------

This is the configuration to use if you want to:
  * force the use of HTTPS for working in the ZMI
  * force the use of HTTPS for authenticated users (because for logged users
    cookies containing vulnerable login/password information is sent with each
    request)

<VirtualHost 192.168.2.20:80>
ServerName mysite.net

RewriteEngine on

# Using OR instead of the implicit AND between conditions
RewriteCond %{REQUEST_URI} ^(.*)/manage$ [OR]
RewriteCond %{REQUEST_URI} ^(.*)/login_form$
RewriteRule ^/(.*) https://mysite.net/$1 [R=permanent,L]

RewriteCond %{HTTP:Authorization}  ^(.*)
RewriteRule ^/(.*) http://demo1.localdomain:9673/VirtualHostBase/http/%{HTTP_HOST}:80/cps/VirtualHostRoot/$1 [P,L]

CustomLog /var/log/apache-ssl/mysite.net.log combined
ErrorLog /var/log/apache-ssl/mysite.net-error.log
</VirtualHost>

<VirtualHost 192.168.2.20:443>
ServerName mysite.net
SSLEnable

RewriteEngine on

RewriteCond %{HTTP:Authorization}  ^(.*)
RewriteRule ^/(.*)  http://demo1.localdomain:9673/VirtualHostBase/https/%{HTTP_HOST}:443/cps/VirtualHostRoot/$1 [P,L]

CustomLog /var/log/apache-ssl/mysite.net.log combined
ErrorLog /var/log/apache-ssl/mysite.net-error.log
</VirtualHost>



Related bug reports
-------------------

- bug #436
  "getBaseUrl.py doesn't work as expected behind Apache virtual hosts"
  http://bugs.nuxeo.com/bugzilla/show_bug.cgi?id=436

